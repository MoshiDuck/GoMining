<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Simulateur GoMining Friendly</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial, sans-serif; background: #f0f3f5; color: #333; padding: 20px; }
h1 { color: #2c3e50; text-align: center; }
.container { max-width: 900px; margin: auto; }
.card { background: white; padding: 15px; margin: 15px 0; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);}
label { display: block; margin-top: 10px; font-weight: bold; }
input, select { padding: 5px; margin-top: 5px; width: 120px; }
button { margin-top: 15px; padding: 10px 20px; background: #27ae60; color: white; border: none; cursor: pointer; border-radius: 5px;}
button:hover { background: #2ecc71; }
table { border-collapse: collapse; width: 100%; margin-top: 15px; }
th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
th { background: #2980b9; color: white; }
canvas { margin-top: 20px; background: white; padding: 10px; border-radius: 8px; }
.info { font-size: 0.9em; color: #555; margin-top: 5px;}
</style>
</head>
<body>
<div class="container">
<h1>Simulateur GoMining Friendly</h1>

<div class="card">
  <label>TH actuel : <input type="number" id="th" value="28"></label>
  <label>Remise (%) : <input type="number" id="remise" value="24.4"></label>
  <label>Watt/TH : <input type="number" id="watt" value="15"></label>
  <label>Strat√©gie : 
    <select id="strategy">
      <option value="gomining">Gomining (cumul√©)</option>
      <option value="reinvest">R√©investissement (pas cumul√©s)</option>
    </select>
  </label>
  <label>P√©riode : 
    <select id="unit">
      <option value="1">Jours</option>
      <option value="2">Mois</option>
      <option value="3">Ann√©es</option>
    </select>
  </label>
  <label>Nombre : <input type="number" id="timeValue" value="5"></label>
  <button onclick="simulate()">Simuler</button>
  <div class="info">üí° Gomining = gains cumul√©s, R√©investissement = gains du jour seulement. Halving BTC pris en compte.</div>
</div>

<div class="card table-container">
  <h3 id="tableTitle">Tableau des r√©sultats</h3>
  <table id="resultTable">
    <thead>
      <tr>
        <th>Jour</th>
        <th>Puissance TH</th>
        <th>Gain GMT</th>
        <th>Gain USD</th>
        <th>Gain sat</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="card">
  <canvas id="chart" width="800" height="300"></canvas>
</div>
</div>

<script>
let chartInstance = null;

// Fonction pour calculer le reward par TH selon la date et les halvings
function getRewardPerTH(currentDate) {
    const lastHalving = new Date("2024-04-01"); // dernier halving
    const initialReward = 49; // satoshi/TH/jour avant halving
    const yearDiff = currentDate.getFullYear() - lastHalving.getFullYear();
    const monthDiff = currentDate.getMonth() - lastHalving.getMonth();
    const totalYears = yearDiff + monthDiff/12;
    const halvingsSince = Math.floor(totalYears / 4);
    return initialReward / Math.pow(2, halvingsSince);
}

async function simulate() {
  const thInput = parseFloat(document.getElementById("th").value);
  const remise = parseFloat(document.getElementById("remise").value);
  const watt = parseFloat(document.getElementById("watt").value);
  const strategy = document.getElementById("strategy").value;
  const unit = document.getElementById("unit").value;
  const timeValue = parseInt(document.getElementById("timeValue").value);

  const res = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,gmt-token&vs_currencies=usd,eur");
  const data = await res.json();
  const btcUSD = data.bitcoin.usd;
  const gmtUSD = data["gmt-token"].usd;

  let totalDays = 1;
  if (unit == "1") totalDays = timeValue;
  else if (unit == "2") totalDays = timeValue * 30;
  else if (unit == "3") totalDays = timeValue * 365;

  let th = thInput;
  let tbody = document.querySelector("#resultTable tbody");
  tbody.innerHTML = "";
  document.getElementById("tableTitle").innerText = strategy=="gomining"?"Tableau Gomining Cumul√©":"Tableau R√©investissement";

  let labels = [], gainHistory = [];
  let cumulativeRewardSat = 0;

  for (let day = 1; day <= totalDays; day++) {
    const currentDate = new Date();
    const rewardPerTH = getRewardPerTH(currentDate);

    const electricityFee = (0.05*24*watt/gmtUSD/1000)*(1-remise/100);
    const serviceFee = (0.0089/gmtUSD)*(1-remise/100);
    const rewardNet = rewardPerTH*th - (electricityFee*th + serviceFee*th);

    let displayReward = rewardNet;
    if(strategy=="gomining") cumulativeRewardSat += rewardNet; else cumulativeRewardSat = rewardNet;

    if(strategy=="reinvest"){
      const rewardUSD = (rewardNet/1e8)*btcUSD;
      const reinvestUSD = rewardUSD*1.05;
      const thBought = reinvestUSD/28;
      th += thBought;
    }

    if ((unit=="2" && day%30==0) || (unit=="3" && day%365==0) || unit=="1") {
      const rewardUSD = (displayReward/1e8)*btcUSD;
      const rewardGMT = rewardUSD/gmtUSD;
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${day}</td>
        <td>${th.toFixed(6)}</td>
        <td>${(strategy=="gomining"?cumulativeRewardSat/1e8*btcUSD/gmtUSD:rewardGMT).toFixed(6)}</td>
        <td>${(strategy=="gomining"?cumulativeRewardSat/1e8*btcUSD:rewardUSD).toFixed(6)}</td>
        <td>${(strategy=="gomining"?cumulativeRewardSat:rewardNet).toFixed(2)}</td>
      `;
      tbody.appendChild(row);

      labels.push(day);
      gainHistory.push(strategy=="gomining"?cumulativeRewardSat:rewardNet);
    }
  }

  if(chartInstance) chartInstance.destroy();
  const ctx = document.getElementById("chart").getContext("2d");
  const gainMin = Math.min(...gainHistory), gainMax = Math.max(...gainHistory);

  chartInstance = new Chart(ctx, {
    type: "line",
    data: {
      labels: labels,
      datasets: [{ label: "Gain sat/jour", data: gainHistory, borderColor: "green", fill: false, tension: 0.3 }]
    },
    options: {
      responsive:true,
      plugins:{legend:{position:'top'}, tooltip:{mode:'index',intersect:false}},
      scales:{y:{beginAtZero:false, min:gainMin*0.999, max:gainMax*1.001, title:{display:true,text:'Gain sat/jour'}}}
    }
  });
}
</script>

</body>
</html>
