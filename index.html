<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Simulateur GoMining — Don plein largeur</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  :root{
    --bg:#eef2f7; --card:#fff; --accent:#2980b9; --accent-2:#27ae60; --muted:#6b7280;
  }
  body{font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:var(--bg); color:#212529; margin:0;}
  .container{max-width:1100px;margin:18px auto;padding:16px;}
  h1{text-align:center;color:#213246;margin:6px 0 14px;}
  .tabs{display:flex;gap:10px;margin-bottom:8px;flex-wrap:wrap;}
  .tab-btn{flex:1;padding:12px;background:var(--accent);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700}
  .tab-btn.active{background:var(--accent-2)}
  .don-button-row{display:block;margin-bottom:12px}
  .btn-don{display:block;width:100%;padding:12px;border-radius:10px;border:none;background:#f59e0b;color:white;font-weight:700;cursor:pointer}
  .tab-content{display:none}
  .tab-content.active{display:block}
  .card{background:var(--card);border-radius:12px;box-shadow:0 6px 18px rgba(15,30,40,0.06);padding:18px;margin-bottom:14px}
  label{display:block;font-weight:600;margin-top:10px}
  input, select{width:100%;padding:10px;border-radius:8px;border:1px solid #d5dce6;margin-top:6px}
  button.primary{width:100%;padding:12px;border-radius:10px;border:none;background:var(--accent-2);color:#fff;font-weight:700;margin-top:12px;cursor:pointer}
  .flex-info{display:flex;gap:12px;flex-wrap:wrap;margin-top:14px}
  .info-card{flex:1;min-width:140px;background:#f7fbff;padding:12px;border-radius:10px;text-align:center;box-shadow:0 2px 8px rgba(10,20,30,0.03)}
  .table-wrap{overflow:auto}
  table{width:100%;border-collapse:collapse;min-width:720px}
  th,td{padding:10px;border:1px solid #e6eef6;text-align:center;font-size:0.95rem}
  th{background:var(--accent);color:#fff;font-weight:700}
  canvas{width:100%!important;height:420px!important}
  .don-grid{display:flex;flex-direction:column;gap:12px}
  .don-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .addr{background:#f1f5f9;padding:8px;border-radius:8px;flex:1;word-break:break-all;font-family:monospace}
  .copy-btn{padding:8px 10px;border-radius:8px;border:0;cursor:pointer;background:#2563eb;color:white;font-weight:700}
  .tag{display:inline-block;padding:4px 8px;border-radius:6px;background:#eef2ff;color:#2563eb;font-weight:700;font-size:0.82rem;margin-bottom:6px}
  .warn{background:#fff4e5;border-left:4px solid #ffb020;padding:10px;border-radius:6px;color:#6b4b00;margin:10px 0}
  .small{font-size:0.85rem;color:var(--muted)}
  .promo{background:linear-gradient(90deg,#e6f9f0,#f0fbff);border:1px solid #cfeee0;padding:14px;border-radius:10px;display:flex;align-items:center;justify-content:space-between;gap:12px}
  .promo-code{font-family:monospace;background:#fff;padding:8px 12px;border-radius:8px;border:1px dashed #b7e3c9;font-weight:800}
  .toast{position:fixed;right:18px;bottom:18px;background:#111;color:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.2);display:none}
  @media(max-width:720px){ .info-card{min-width:100%} .don-row{flex-direction:column;align-items:stretch} .promo{flex-direction:column;align-items:stretch} }
</style>
</head>
<body>
<div class="container">
  <h1>Simulateur GoMining — Don plein largeur</h1>

  <!-- onglets principaux : 3 -->
  <div class="tabs">
    <button class="tab-btn active" onclick="showMainTab(0)">Simulation</button>
    <button class="tab-btn" onclick="showMainTab(1)">Résultats</button>
    <button class="tab-btn" onclick="showMainTab(2)">Graphique</button>
  </div>

  <!-- bouton Don plein largeur (sous les onglets) -->
  <div class="don-button-row">
    <button class="btn-don" onclick="showDon()">Don</button>
  </div>

  <!-- SIMULATION -->
  <div id="tab-sim" class="tab-content active">
    <div class="card">
      <label>TH actuel</label>
      <input id="th" type="number" value="28" step="0.000001" />

      <label>Remise (%)</label>
      <input id="remise" type="number" value="24.4" step="0.1" />

      <label>Watt / TH</label>
      <input id="watt" type="number" value="15" step="0.1" />

      <label>Stratégie</label>
      <select id="strategy">
        <option value="gomining">1 — Gomining (cumulé)</option>
        <option value="reinvest">2 — Réinvestissement (non cumulés)</option>
      </select>

      <label>Période</label>
      <select id="unit">
        <option value="1">1 — Jours</option>
        <option value="2">2 — Mois</option>
        <option value="3">3 — Années</option>
      </select>

      <label>Nombre (ex : 5)</label>
      <input id="timeValue" type="number" value="5" />

      <label>Croissance annuelle BTC (%)</label>
      <input id="btcGrowth" type="number" value="20" step="0.1" />

      <button class="primary" onclick="simulate()">Simuler</button>
      <div class="small" style="margin-top:8px">Gomining cumule les récompenses ; Réinvestissement convertit & augmente le TH quotidien (+5% réinvestissement). Halving, frais, hashrate & BTC growth appliqués.</div>
    </div>

    <div class="flex-info">
      <div class="info-card">Prix BTC : <div id="btcPrice">—</div></div>
      <div class="info-card">Hashrate réseau : <div id="networkHashrate">—</div> TH/s</div>
      <div class="info-card">Prix GoMining (GMT) : <div id="gmtPrice">—</div></div>
      <div class="info-card">Reward brut / TH : <div id="rewardPerTHDisplay">—</div> sat/jour</div>
      <div class="info-card">Prochain halving : <div id="nextHalving">—</div></div>
    </div>
  </div>

  <!-- RESULTS -->
  <div id="tab-res" class="tab-content">
    <div class="card table-wrap">
      <h3 id="tableTitle">Tableau des résultats</h3>
      <table id="resultTable">
        <thead>
          <tr>
            <th>Jour</th>
            <th>Puissance TH</th>
            <th>Reward brut (sat)</th>
            <th>Frais électricité (sat)</th>
            <th>Frais service (sat)</th>
            <th>Gain net (sat)</th>
            <th>Gain net ($)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- CHART -->
  <div id="tab-chart" class="tab-content">
    <div class="card">
      <canvas id="chart"></canvas>
    </div>
  </div>

  <!-- DON (onglet accessible via bouton Don plein largeur) -->
  <div id="tab-don" class="tab-content">
    <div class="card">
      <div class="promo">
        <div>
          <div style="font-weight:800">Code promo — <span style="color:#0b6b3b">+5% sur vos premiers mineurs</span></div>
          <div class="small">Partagez ce code : <strong>JUC1Z92</strong></div>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <div class="promo-code" id="promo_code">JUC1Z92</div>
          <button class="copy-btn" onclick="copyPromo()">Copier le code</button>
        </div>
      </div>

      <div class="warn" style="margin-top:12px">
        <strong>ATTENTION :</strong> Vérifie toujours le <em>réseau</em> avant d'envoyer (ERC20 vs BEP20 vs native coin). Les adresses token (GOMINING / GMT) sont spécifiques au réseau. N'envoie pas un token sur l'adresse d'une chaîne différente.
      </div>

      <div class="don-grid" style="margin-top:12px">
        <div>
          <div class="tag">GOMINING (GMT) — BNB Chain (BEP20)</div>
          <div class="don-row">
            <div class="addr" id="addr_gmt_bep">0xF7f34ecB6c5f3F1C06C4387AC9c5cB7eDD488e8f</div>
            <button class="copy-btn" onclick="copyAddr('addr_gmt_bep')">Copier</button>
          </div>
          <div class="small">Minimum suggéré : <strong>10 GMT</strong></div>
        </div>

        <div>
          <div class="tag">GOMINING (GMT) — Ethereum (ERC20)</div>
          <div class="don-row">
            <div class="addr" id="addr_gmt_erc">0xF7f34ecB6c5f3F1C06C4387AC9c5cB7eDD488e8f</div>
            <button class="copy-btn" onclick="copyAddr('addr_gmt_erc')">Copier</button>
          </div>
          <div class="small">Minimum suggéré : <strong>10 GMT</strong></div>
        </div>

        <div>
          <div class="tag">GOMINING — TON</div>
          <div class="don-row">
            <div class="addr" id="addr_ton">UQAc0FYVmX9dNSnjkj1KDT1chcQSV-bxeYuAz7lz8qubh6Qz</div>
            <button class="copy-btn" onclick="copyAddr('addr_ton')">Copier</button>
          </div>
          <div class="small">Minimum : <strong>10 GMT</strong></div>
        </div>

        <div>
          <div class="tag">GOMINING — Solana (SPL)</div>
          <div class="don-row">
            <div class="addr" id="addr_sol">9CzP4YfcrALBLmzfLjqpErfLtAsGaAKpM9C7T3fP2v4s</div>
            <button class="copy-btn" onclick="copyAddr('addr_sol')">Copier</button>
          </div>
          <div class="small">Minimum : <strong>10 GMT</strong></div>
        </div>

        <div>
          <div class="tag">Paiement ETH (native) — min 0.0025 ETH</div>
          <div class="don-row">
            <div class="addr" id="addr_eth_native">0xF7f34ecB6c5f3F1C06C4387AC9c5cB7eDD488e8f</div>
            <button class="copy-btn" onclick="copyAddr('addr_eth_native')">Copier</button>
          </div>
          <div class="small">Vérifie réseau EVM avant d'envoyer.</div>
        </div>

        <div>
          <div class="tag">BTC on-chain — min 0.00001 BTC</div>
          <div class="don-row">
            <div class="addr" id="addr_btc">bc1qtw95rgr9atshrdrt8xyyjdv8c8hpltqsa3hy73</div>
            <button class="copy-btn" onclick="copyAddr('addr_btc')">Copier</button>
          </div>
        </div>

        <div>
          <div class="tag">USDC (ERC20 / BEP20) — min 10 USDC</div>
          <div class="don-row">
            <div class="addr" id="addr_usdc">0xF7f34ecB6c5f3F1C06C4387AC9c5cB7eDD488e8f</div>
            <button class="copy-btn" onclick="copyAddr('addr_usdc')">Copier</button>
          </div>
        </div>

      </div>
    </div>
  </div>

</div>

<div id="toast" class="toast"></div>

<script>
/* ------------- UI helpers ------------- */
function showMainTab(idx){
  // main three tabs
  document.getElementById('tab-sim').classList.toggle('active', idx===0);
  document.getElementById('tab-res').classList.toggle('active', idx===1);
  document.getElementById('tab-chart').classList.toggle('active', idx===2);
  // hide don tab when switching main
  document.getElementById('tab-don').classList.remove('active');
  // manage active class visuals on main tab buttons
  document.querySelectorAll('.tab-btn').forEach((el,i)=> el.classList.toggle('active', i===idx));
}
function showDon(){
  // hide other main tabs
  document.getElementById('tab-sim').classList.remove('active');
  document.getElementById('tab-res').classList.remove('active');
  document.getElementById('tab-chart').classList.remove('active');
  // show don tab
  document.getElementById('tab-don').classList.add('active');
  // remove highlight from main tabs
  document.querySelectorAll('.tab-btn').forEach(el=> el.classList.remove('active'));
}
function showToast(msg, ms=1600){
  const t = document.getElementById('toast');
  t.textContent = msg; t.style.display='block';
  setTimeout(()=> t.style.display='none', ms);
}
function copyAddr(id){
  const txt = document.getElementById(id).innerText.trim();
  if(!txt) return showToast('Aucune adresse disponible');
  navigator.clipboard?.writeText(txt).then(()=> showToast('Adresse copiée ✔')).catch(()=> { alert('Copie non supportée, sélectionne manuellement :\\n' + txt); });
}
function copyPromo(){
  const code = document.getElementById('promo_code').innerText.trim();
  if(!code) return showToast('Aucun code');
  navigator.clipboard?.writeText(code).then(()=> showToast('Code promo copié ✔')).catch(()=> { alert('Copie non supportée, sélectionne manuellement :\\n' + code); });
}

/* ------------- Model & simulate (identique logiques précédentes) ------------- */
const HALVING_REF = new Date("2024-04-20");
const REWARD_AT_REF = 49;
const ENERGY_PRICE_USD_PER_KWH = 0.05;
const SERVICE_USD_PER_TH_PER_DAY = 0.0089;

function halvingsSinceRef(date){
  const diff = date - HALVING_REF;
  const years = diff / (1000*60*60*24*365);
  return Math.floor(years / 4);
}
function getRewardPerTH(date){
  const k = halvingsSinceRef(date);
  return REWARD_AT_REF / Math.pow(2, k);
}
function getNextHalving(date){
  const k = halvingsSinceRef(date);
  const next = new Date(HALVING_REF);
  next.setFullYear(HALVING_REF.getFullYear() + 4*(k+1));
  return next;
}
function computeHashrateForMonthFactor(growthRateMonthly, monthsElapsed, baseHashrate){
  return baseHashrate * Math.pow(1 + growthRateMonthly, monthsElapsed);
}
function halvingDaysInRange(startDate, totalDays){
  const endDate = new Date(startDate);
  endDate.setDate(startDate.getDate() + totalDays - 1);
  const arr=[];
  let hDate = new Date(HALVING_REF);
  while(hDate > endDate){
    hDate = new Date(hDate); hDate.setFullYear(hDate.getFullYear() - 4);
  }
  while(hDate <= endDate){
    if(hDate >= startDate){
      const dayIndex = Math.floor((hDate - startDate) / (1000*60*60*24)) + 1;
      if(dayIndex >=1 && dayIndex <= totalDays) arr.push(dayIndex);
    }
    hDate = new Date(hDate); hDate.setFullYear(hDate.getFullYear() + 4);
  }
  return arr;
}

let chartInstance = null;
async function simulate(){
  const thInput = parseFloat(document.getElementById('th').value) || 0;
  const remise = parseFloat(document.getElementById('remise').value) || 0;
  const watt = parseFloat(document.getElementById('watt').value) || 0;
  const strategy = document.getElementById('strategy').value;
  const unit = document.getElementById('unit').value;
  const timeValue = parseInt(document.getElementById('timeValue').value) || 0;
  const btcAnnualGrowth = (parseFloat(document.getElementById('btcGrowth').value)||0) / 100;

  let btcUSD = 0, btcEUR=0, gmtUSD=1, gmtEUR=1;
  try{
    const r = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,gmt-token&vs_currencies=usd,eur");
    const data = await r.json();
    btcUSD = data.bitcoin.usd; btcEUR = data.bitcoin.eur;
    gmtUSD = data["gmt-token"]?.usd ?? 1; gmtEUR = data["gmt-token"]?.eur ?? 1;
  }catch(e){
    console.warn('Coingecko fetch failed:', e);
  }

  document.getElementById('btcPrice').innerText = btcUSD ? `$${btcUSD.toLocaleString()} / €${btcEUR?.toLocaleString()}` : '—';
  document.getElementById('gmtPrice').innerText = gmtUSD ? `$${gmtUSD.toLocaleString()} / €${gmtEUR?.toLocaleString()}` : '—';
  document.getElementById('rewardPerTHDisplay').innerText = getRewardPerTH(new Date()).toFixed(6);
  document.getElementById('nextHalving').innerText = getNextHalving(new Date()).toLocaleDateString();

  const baseHashrate = 500000;
  const growthRateMonthly = 0.03 + Math.random()*0.02;

  let totalDays = 1;
  if(unit==='1') totalDays = timeValue;
  else if(unit==='2') totalDays = timeValue * 30;
  else totalDays = timeValue * 365;

  const tbody = document.querySelector('#resultTable tbody');
  tbody.innerHTML = '';

  let th = thInput;
  let cumulativeRewardSat = 0;
  const startDate = new Date();
  let currentBTC = btcUSD;
  let lastBTC = currentBTC;
  const labels = [];
  const gainHistory = [];
  const halvingDays = halvingDaysInRange(startDate, totalDays);

  for(let day=1; day<=totalDays; day++){
    const date = new Date(startDate);
    date.setDate(startDate.getDate() + day - 1);

    const rewardPerTH = getRewardPerTH(date);
    const rewardBrut_sat = rewardPerTH * th;

    const electricity_usd_per_th_per_day_before_discount = ENERGY_PRICE_USD_PER_KWH * 24 * watt / 1000;
    const electricity_usd_per_th_per_day = electricity_usd_per_th_per_day_before_discount * (1 - remise/100);
    const service_usd_per_th_per_day = SERVICE_USD_PER_TH_PER_DAY * (1 - remise/100);
    const total_fees_usd = (electricity_usd_per_th_per_day + service_usd_per_th_per_day) * th;

    let total_fees_sat = 0;
    let elec_fee_sat = 0, serv_fee_sat = 0;
    if(btcUSD && btcUSD > 0){
      total_fees_sat = (total_fees_usd / btcUSD) * 1e8;
      elec_fee_sat = ((electricity_usd_per_th_per_day * th) / btcUSD) * 1e8;
      serv_fee_sat = ((service_usd_per_th_per_day * th) / btcUSD) * 1e8;
    } else {
      console.warn('btcUSD missing — fees shown as 0 sat');
    }

    const monthsElapsed = Math.floor((day-1)/30);
    const currentHashrate = computeHashrateForMonthFactor(growthRateMonthly, monthsElapsed, baseHashrate);
    if(day===1 || day%30===0) document.getElementById('networkHashrate').innerText = Math.round(currentHashrate).toLocaleString();

    if(day > 1 && lastBTC){
      currentBTC = lastBTC * Math.pow(1 + btcAnnualGrowth, 1/365);
    }
    lastBTC = currentBTC;

    if(strategy === 'gomining'){
      cumulativeRewardSat += rewardBrut_sat - (elec_fee_sat + serv_fee_sat);
    } else {
      cumulativeRewardSat = rewardBrut_sat - (elec_fee_sat + serv_fee_sat);
    }

    if(strategy === 'reinvest'){
      const rewardUSD = ((rewardBrut_sat - (elec_fee_sat + serv_fee_sat)) / 1e8) * (currentBTC || btcUSD || 0);
      const reinvestUSD = rewardUSD * 1.05;
      const thBought = reinvestUSD / 28;
      th += thBought;
    }

    const showRow = (unit === '1') || (unit === '2' && day % 30 === 0) || (unit === '3' && day % 365 === 0);
    if(showRow){
      const rewardNetSat = (strategy === 'gomining') ? cumulativeRewardSat : (rewardBrut_sat - (elec_fee_sat + serv_fee_sat));
      const rewardNetUSD = ((rewardNetSat) / 1e8) * (currentBTC || btcUSD || 0);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${day}</td>
        <td>${th.toFixed(6)}</td>
        <td>${rewardBrut_sat.toFixed(4)}</td>
        <td>${elec_fee_sat.toFixed(4)}</td>
        <td>${serv_fee_sat.toFixed(4)}</td>
        <td>${rewardNetSat.toFixed(4)}</td>
        <td>$${rewardNetUSD.toFixed(2)}</td>
      `;
      tbody.appendChild(tr);
    }

    labels.push(day);
    gainHistory.push((strategy === 'gomining') ? cumulativeRewardSat : (rewardBrut_sat - (elec_fee_sat + serv_fee_sat)));
  }

  document.getElementById('btcPrice').innerText = currentBTC ? `$${currentBTC.toLocaleString(undefined,{maximumFractionDigits:2})}` : '—';

  if(chartInstance) chartInstance.destroy();
  const ctx = document.getElementById('chart').getContext('2d');

  const maxLabels = 8;
  const step = Math.max(1, Math.ceil(labels.length / maxLabels));
  const displayLabels = labels.map((v,i)=> (i % step === 0) ? v : '');

  const halvingLabelIndices = halvingDays.map(d => d - 1).filter(i => i >= 0 && i < labels.length);

  const halvingPlugin = {
    id: 'halvingLines',
    afterDatasetsDraw(chart, args, options){
      if(!options.lines || !options.lines.length) return;
      const {ctx, chartArea, scales} = chart;
      ctx.save();
      ctx.setLineDash([5,4]);
      ctx.lineWidth = options.lineWidth || 1.6;
      ctx.strokeStyle = options.color || 'rgba(0, 120, 255, 0.9)';
      ctx.fillStyle = options.color || 'rgba(0, 120, 255, 0.9)';
      ctx.font = '12px sans-serif';
      options.lines.forEach(idx => {
        const x = scales.x.getPixelForValue(idx);
        if(isFinite(x)){
          ctx.beginPath();
          ctx.moveTo(x, chartArea.top);
          ctx.lineTo(x, chartArea.bottom);
          ctx.stroke();
          ctx.fillText('Halving', x + 6, chartArea.top + 14);
        }
      });
      ctx.restore();
    }
  };
  Chart.register(halvingPlugin);

  const dataset = {
    label: 'Gain net sat/jour',
    data: gainHistory,
    borderColor: function(context){
      const i = context.dataIndex;
      if(i === 0) return 'green';
      return gainHistory[i] < gainHistory[i-1] ? 'red' : 'green';
    },
    borderWidth: 2,
    pointRadius: 2,
    fill: false,
    tension: 0.25
  };

  chartInstance = new Chart(ctx, {
    type: 'line',
    data: { labels: displayLabels, datasets: [dataset] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position:'top', labels:{font:{size:13}} },
        tooltip: { mode:'index', intersect:false },
        halvingLines: { lines: halvingLabelIndices, color:'rgba(0,120,255,0.9)', lineWidth:1.6 }
      },
      scales: {
        x: {
          ticks: { autoSkip: false, maxRotation: 0, font: { size: 12 } },
          title: { display: true, text: 'Jours (index)', font: { size: 13 } }
        },
        y: {
          beginAtZero: false,
          ticks: { font: { size: 12 } },
          title: { display: true, text: 'Gain net (sat/jour)', font: { size: 13 } },
          min: Math.min(...gainHistory) * 0.999,
          max: Math.max(...gainHistory) * 1.001
        }
      }
    }
  });

  // switch to Results tab
  showMainTab(1);
}
</script>
</body>
</html>
